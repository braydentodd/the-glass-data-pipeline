name: Annual Maintenance (August 1st)

on:
  schedule:
    # Run once per year on August 1st at 4 AM EST (9 AM UTC) - 1 hour before daily ETL
    - cron: '0 9 1 8 *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual trigger for testing'

jobs:
  # Annual maintenance: cleanup inactive players + update height/weight/birthdate for all players
  # Split into two batches (A-J and K-Z) to avoid NBA API rate limits (~600 requests per session)
  annual_etl_batch_1:
    name: Annual ETL - Players A-J
    runs-on: [self-hosted, Linux, X64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python environment
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run annual ETL batch 1 (A-J players, ~10 minutes)
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        PYTHONUNBUFFERED: "1"
      run: |
        source venv/bin/activate
        echo "üóìÔ∏è Running annual maintenance (Batch 1: A-J)..."
        echo "  - Deleting inactive players (no stats in last 2 seasons)"
        echo "  - Updating height, weight, birthdate for players A-J"
        python3 -u -m src.etl_annual --name-range A-J
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: annual-etl-batch-1-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 30  # Keep longer for annual runs

  annual_etl_batch_2:
    name: Annual ETL - Players K-Z
    runs-on: [self-hosted, Linux, X64]
    needs: annual_etl_batch_1  # Wait for batch 1 to complete
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python environment
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Wait 5 minutes before batch 2 (rate limit cooldown)
      run: |
        echo "‚è∏Ô∏è Waiting 5 minutes for NBA API rate limit reset..."
        sleep 300
    
    - name: Run annual ETL batch 2 (K-Z players, ~10 minutes)
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        PYTHONUNBUFFERED: "1"
      run: |
        source venv/bin/activate
        echo "üóìÔ∏è Running annual maintenance (Batch 2: K-Z)..."
        echo "  - Updating height, weight, birthdate for players K-Z"
        python3 -u -m src.etl_annual --name-range K-Z
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: annual-etl-batch-2-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 30  # Keep longer for annual runs
